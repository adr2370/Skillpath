<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<title></title>
		<meta name="description" content="">
		<meta name="viewport" content="width=device-width">
		<link rel="stylesheet" href="css/bootstrap.min.css" type="text/css">
		<link rel="stylesheet" href="css/bootstrap-responsive.min.css" type="text/css">
	</head>
	<body>
		<div style="position: absolute; right: 0px; top: 0px; height: 100%; width: 250px; background-color: grey;">
			<div style="float: left; margin-left: 10px; margin-top: 10px;">
				<img id="photo" src="">
			</div>
			<div id="name" style="float: left; margin-left: 10px; margin-top: 26px; font-size: 18px;">
			</div>
			<div style="float: left; margin-left: 10px; margin-top: 10px; clear: both;">
				<input placeholder="Search..." style=" width: 222px;">
			</div>
			<div id="path" style="float: left; margin-left: 10px; margin-top: 10px; clear: both;">/</div>
			<div id="back" style="float: right; margin-right: 10px; margin-top: 10px;" onclick="goBack();"></div>
			<div id="categories" style="float: left; margin-left: 10px; margin-top: 10px; clear: both;">
			</div>
			<div style="float: left; margin-left: 10px; margin-top: 10px; clear: both;">
				Goals
			</div>
			<div id="goals" style="float: left; margin-left: 10px; margin-top: 10px; clear: both;">
			</div>
		</div>
		<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js" type="text/javascript"></script>
		<script src='//cdn.firebase.com/v0/firebase.js'></script>
		<script src='//cdn.firebase.com/v0/firebase-auth-client.js'></script>
		<script src="js/fireFunctions.js" type="text/javascript"></script>
		<script>
			var authClient = new FirebaseAuthClient(fb,function(){});
			var userid=authClient.readCookie("cookie");
			var dirLevels=[];
			//if(userid==null) window.location.href="index.html";
			userid=100001711440164;
			var userfb=fb.child("user").child(userid);
			userfb.child("name").on("value", function(data) {
				$("#name").text(data.val());
			});
			userfb.child("photo").on("value", function(data) {
				$("#photo").attr("src",data.val());
			});
			userfb.child("categories").on("child_added", function(data) {
				fb.child("tree").child(data.name()).child("name").once("value", function(data2) {
					addToCategoryList(data.name(),data2.val());
					$("#"+data.name()).attr("onclick","switchToTopDir('"+data.name()+"')");
				});
			});
			userfb.child("goals").on("child_added", function(data) {
				fb.child("node").child(data.name()).child("name").once("value", function(data2) {
					$("#goals").append("<div id='"+data.name()+"'>"+data2.val()+"</div>");
					$("#"+data.name()).click(function() {
						//switch to goal this.id
					});
				});
			});
			function addToCategoryList(id,name) {
				$("#categories").append("<div class='btn btn-inverse' style='width:200px; float: left;clear: both;' id='"+id+"'>"+name+"</div>");
			}
			function goBack() {
				if(dirLevels.length<=1) {
					$("#back").text("");
					$("#back").removeClass("btn");
					$("#back").removeClass("btn-danger");
				}
				if(dirLevels.length>0) {
					$("#categories").html(dirLevels[dirLevels.length-1]);
					dirLevels.splice(dirLevels.length-1, 1);
					var t=$("#path").html();
					t=t.substring(0,t.length-1);
					$("#path").html(t.substring(0,1+t.lastIndexOf("/")));
				}
			}
			function clearCategories() {
				dirLevels[dirLevels.length]=$("#categories").html();
				$("#categories").html("");
				$("#back").text("Go Back");
				$("#back").addClass("btn");
				$("#back").addClass("btn-danger");
			}
			function addToPath(id) {
				$("#path").html($("#path").html()+$("#"+id).text()+"/");
			}
			function switchToTopDir(id) {
				addToPath(id);
				clearCategories();
				fb.child("tree").child(id).child("levels").child("0").once("value", function(dtop) {
					dtop.forEach(function(data) {
						fb.child("tree").child(data.name()).child("name").once("value", function(data2) {
							addToCategoryList(data.name(),data2.val());
							$("#"+data.name()).attr("onclick","switchToSubCategory('"+id+"','"+data.name()+"');");
						});
					});
				});
			}
			function switchToSubCategory(treeid,id) {
				addToPath(id);
				clearCategories();
				//check if it is a leaf
				fb.child("tree").child(treeid).child("nodes").child(id).child("children").once("value", function(dtop) {
					var count=0;
					dtop.forEach(function() {count++;}); //count the children
					if(count==0) {
						//switch to tutorial tree
						switchToTutorialTree(id);
					} else {
						dtop.forEach(function(data) {
							fb.child("tree").child(data.name()).child("name").once("value", function(data2) {
								addToCategoryList(data.name(),data2.val());
								$("#"+data.name()).attr("onclick","switchToSubCategory('"+treeid+"','"+data.name()+"');");
							});
						});
					}
				});
			}
			function switchToTutorialTree(id) {
				fb.child("tree").child(id).child("levels").child("0").once("value", function(dtop) {
					dtop.forEach(function(data) {
						fb.child("node").child(data.name()).child("name").once("value", function(data2) {
							addToCategoryList(data.name(),data2.val());
							$("#"+data.name()).attr("onclick","switchToSubTutorialTree('"+id+"','"+data.name()+"');");
						});
					});
				});
			}
			function switchToSubTutorialTree(treeid,id) {
				addToPath(id);
				clearCategories();
				fb.child("tree").child(treeid).child("nodes").child(id).child("children").once("value", function(dtop) {
					var count=0;
					dtop.forEach(function() {count++;}); //count the children
					if(count==0) {
						//go to the node page for this
					} else {
						dtop.forEach(function(data) {
							fb.child("node").child(data.name()).child("name").once("value", function(data2) {
								addToCategoryList(data.name(),data2.val());
								$("#"+data.name()).attr("onclick","switchToSubTutorialTree('"+treeid+"','"+data.name()+"');");
							});
						});
					}
				});
			}
		</script>
	</body>
</html>
