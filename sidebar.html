<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN">
<html>
	<head>
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
		<title></title>
		<meta name="description" content="">
		<meta name="viewport" content="width=device-width">
		<link rel="stylesheet" href="css/bootstrap.min.css" type="text/css">
		<link rel="stylesheet" href="css/bootstrap-responsive.min.css" type="text/css">
	</head>
	<body>
		<div style="position: fixed; right: 0px; top: 0px; height: 100%; width: 250px; background-color: grey;">
			<div style="float: left; margin-left: 10px; margin-top: 10px;">
				<img id="photo" src="">
			</div>
			<div id="name" style="float: left; margin-left: 10px; margin-top: 26px; font-size: 18px;">
			</div>
			<div style="float: left; margin-left: 10px; margin-top: 10px; clear: both;">
				<input id="search" type="text" data-provide="typeahead">
			</div>
			<div id="path" style="float: left; margin-left: 10px; margin-top: 10px; clear: both;">/</div>
			<div id="back" style="float: right; margin-right: 10px; margin-top: 10px;" onclick="goBack();"></div>
			<div id="categories" style="float: left; margin-left: 10px; margin-top: 10px; clear: both;">
			</div>
			<div style="float: left; margin-left: 10px; margin-top: 10px; clear: both;">
				Goals
			</div>
			<div id="addGoalButton" class="btn btn-danger" style="float: right; margin-right: 10px; margin-top: 10px;" onclick="showAddingGoal();">Add Goal</div>
			<div id="addingGoal" style="display:none;float: left;margin-left: 10px;margin-top: 10px;margin-bottom: -10px;">
				<input id="addGoal" type="text" data-provide="typeahead">
			</div>
			<div id="goals" style="float: left; margin-left: 10px; margin-top: 10px; clear: both;">
			</div>
		</div>
		<div id="graph">
		</div>
		<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js" type="text/javascript"></script>
		<script src='//cdn.firebase.com/v0/firebase.js'></script>
		<script src='//cdn.firebase.com/v0/firebase-auth-client.js'></script>
		<script src="js/bootstrap.js" type="text/javascript"></script>
		<script src="js/fireFunctions.js" type="text/javascript"></script>
		<script src="http://d3js.org/d3.v3.min.js"></script>
		<script>
			var authClient = new FirebaseAuthClient(fb,function(){});
			var userid=authClient.readCookie("cookie");
			var dirLevels=[];
			var oldTrees=[];
			var inTutorials=false;
			var howFarIn=0;
			var currCategoryTree="";
			var currTutorialTree="";
			var names=[];
			var listNames=[];
			var possibleGoals=[];
			var listGoals=[];
			fb.once("value", function(data) {
				data.child("tree").forEach(function(t) {
					var tree=new Object();
					tree.type="tree";
					tree.id=t.name();
					tree.name=t.child("name").val();
					names[tree.name]=tree;
					listNames.push(tree.name);
				});
				data.child("node").forEach(function(n) {
					var node=new Object();
					node.type="node";
					node.id=n.name();
					node.name=n.child("name").val();
					names[node.name]=node;
					listNames.push(node.name);
				});
			});
			$("#search").typeahead({
				source: function (query, process) {
					return listNames;
				},
				updater: function (item) {
					console.log(item);
					console.log(names[item]);
				}
			});
			//if(userid==null) window.location.href="index.html";
			userid=100001711440164;
			var userfb=fb.child("user").child(userid);
			userfb.child("name").on("value", function(data) {
				$("#name").text(data.val());
			});
			userfb.child("photo").on("value", function(data) {
				$("#photo").attr("src",data.val());
			});
			userfb.child("categories").on("child_added", function(data) {
				fb.child("tree").child(data.name()).child("name").once("value", function(data2) {
					addToCategoryList(data.name(),data2.val());
					$("#"+data.name()).attr("onclick","switchToTopDir('"+data.name()+"')");
				});
			});
			userfb.child("goals").on("child_added", function(data) {
				fb.child("node").child(data.name()).child("name").once("value", function(data2) {
					fb.child("tree").child(data.val()).child("name").once("value", function(data3) {
						$("#goals").append("<div class='btn btn-inverse' style='width:200px; float: left;clear: both;' id='"+data.name()+"'>"+data3.val()+"/"+data2.val()+"</div>");
						$("#"+data.name()).click(function() {
							getPathUp(data.val(),data.name());
						});
					});
				});
			});
			function showAddingGoal() {
				$('#addingGoal').show();
				$("#addGoalButton").text("Hide");
				$("#addGoalButton").attr("onclick","hideAddingGoal();");
				fb.child("user").child(userid).once("value", function(data) {
					data.child("categories").forEach(function(category) {
						fb.child("tree").child(category.name()).once("value", function(trees) {
							trees.child("nodes").forEach(function(tree) {
								fb.child("tree").child(tree.name()).once("value", function(nodes) {
									nodes.child("nodes").forEach(function(node) {
										fb.child("node").child(node.name()).once("value", function(name) {
											var nameOfGoal=trees.child("name").val()+"/"+nodes.child("name").val()+"/"+name.child("name").val();
											listGoals.push(nameOfGoal);
											var obj=new Object();
											obj.category=trees.name();
											obj.tree=nodes.name();
											obj.node=name.name();
											possibleGoals[nameOfGoal]=obj;
										});
									});
								});
							});
						});
					});
				});
				$("#addGoal").typeahead({
					source: function (query, process) {
						return listGoals;
					},
					updater: function (item) {
						var goal=possibleGoals[item];
						addGoal(userid,goal.tree,goal.node);
					}
				});
			}
			function hideAddingGoal() {
				$("#addingGoal").hide();
				$("#addGoalButton").text("Add Goal");
				$("#addGoalButton").attr("onclick","showAddingGoal();");
				listGoals=[];
				possibleGoals=[];
			}
			function getPathUp(treeid,id) {
				//clean up old stuff
				$("#back").text("");
				$("#back").removeClass("btn");
				$("#back").removeClass("btn-danger");
				$("#path").html("/");
				$("#categories").html(dirLevels[0]);
				dirLevels=[];
				oldTrees=[];
				//find which category the treeid belongs to
				var category="";
				fb.child("user").child(userid).child("categories").once("value", function(data) {
					data.forEach(function(tree) {
						if(category=="") {
							fb.child("tree").child(tree.name()).child("nodes").once("value", function(n) {
								n.forEach(function(node) {
									if(category==""&&node.name()==treeid) {
										category=tree.name();
										findAllTreeParents(category,treeid,id);
									}
								});
							});
						}
					});
				});
			}
			function findAllTreeParents(category,treeid,id) {
				var nodes=[];
				fb.child("tree").child(category).child("nodes").once("value", function(data) {
					nodes.push(treeid);
					var index=nodes.length-1;
					var nodeCount=nodes.length;
					while(index<nodeCount) {
						data.child(nodes[index]).child("parents").forEach(function(parent) {
							if($.inArray(parent.name(),nodes)==-1) {
								nodes.push(parent.name());
								nodeCount++;
							}
						});
						index++;
					}
					findAllSkillParents(category,treeid,id,nodes);
				});
			}
			function findAllSkillParents(category,treeid,id,nodes) {
				fb.child("tree").child(treeid).child("nodes").once("value", function(data) {
					nodes.push(id);
					var index=nodes.length-1;
					var nodeCount=nodes.length;
					while(index<nodeCount) {
						data.child(nodes[index]).child("parents").forEach(function(parent) {
							if($.inArray(parent.name(),nodes)==-1) {
								nodes.push(parent.name());
								nodeCount++;
							}
						});
						index++;
					}
					getGoalTreeData(category,nodes,drawTree);
				});
			}
			function addToCategoryList(id,name) {
				$("#categories").append("<div class='btn btn-inverse' style='width:200px; float: left;clear: both;' id='"+id+"'>"+name+"</div>");
			}
			function goBack() {
				if(dirLevels.length<=1) {
					$("#back").text("");
					$("#back").removeClass("btn");
					$("#back").removeClass("btn-danger");
				}
				if(dirLevels.length<=howFarIn) {
					inTutorials=false;
				}
				if(dirLevels.length>1) {
					$("#graph").html(oldTrees[oldTrees.length-1]);
					oldTrees.splice(oldTrees.length-1, 1);
				} else {
					oldTrees=[];
					$("#graph").html("");
				}
				if(dirLevels.length>0) {
					$("#categories").html(dirLevels[dirLevels.length-1]);
					dirLevels.splice(dirLevels.length-1, 1);
					var t=$("#path").html();
					t=t.substring(0,t.length-1);
					$("#path").html(t.substring(0,1+t.lastIndexOf("/")));
				}
			}
			function clearCategories() {
				dirLevels[dirLevels.length]=$("#categories").html();
				oldTrees[oldTrees.length]=$("#graph").html();
				$("#categories").html("");
				$("#back").text("Go Back");
				$("#back").addClass("btn");
				$("#back").addClass("btn-danger");
			}
			function addToPath(id) {
				$("#path").html($("#path").html()+$("#"+id).text()+"/");
			}
			function switchToTopDir(id) {
				currCategoryTree=id;
				addToPath(id);
				clearCategories();
				getTreeData(id,"tree",drawTree);
				fb.child("tree").child(id).child("levels").child("0").once("value", function(dtop) {
					dtop.forEach(function(data) {
						fb.child("tree").child(data.name()).child("name").once("value", function(data2) {
							addToCategoryList(data.name(),data2.val());
							$("#"+data.name()).attr("onclick","switchToSubCategory('"+id+"','"+data.name()+"');");
						});
					});
				});
			}
			function switchToSubCategory(treeid,id) {
				addToPath(id);
				clearCategories();
				//check if it is a leaf
				fb.child("tree").child(treeid).child("nodes").child(id).child("children").once("value", function(dtop) {
					var count=0;
					dtop.forEach(function() {count++;}); //count the children
					if(count==0) {
						//switch to tutorial tree
						switchToTutorialTree(id);
					} else {
						dtop.forEach(function(data) {
							fb.child("tree").child(data.name()).child("name").once("value", function(data2) {
								addToCategoryList(data.name(),data2.val());
								$("#"+data.name()).attr("onclick","switchToSubCategory('"+treeid+"','"+data.name()+"');");
							});
						});
					}
				});
			}
			function switchToTutorialTree(id) {
				currTutorialTree=id;
				inTutorials=true;
				howFarIn=dirLevels.length;
				getTreeData(id,"node",drawTree);
				fb.child("tree").child(id).child("levels").child("0").once("value", function(dtop) {
					dtop.forEach(function(data) {
						fb.child("node").child(data.name()).child("name").once("value", function(data2) {
							addToCategoryList(data.name(),data2.val());
							$("#"+data.name()).attr("onclick","switchToSubTutorialTree('"+id+"','"+data.name()+"');");
						});
					});
				});
			}
			function switchToSubTutorialTree(treeid,id) {
				addToPath(id);
				clearCategories();
				fb.child("tree").child(treeid).child("nodes").child(id).child("children").once("value", function(dtop) {
					var count=0;
					dtop.forEach(function() {count++;}); //count the children
					if(count==0) {
						//go to the node page for this
					} else {
						dtop.forEach(function(data) {
							fb.child("node").child(data.name()).child("name").once("value", function(data2) {
								addToCategoryList(data.name(),data2.val());
								$("#"+data.name()).attr("onclick","switchToSubTutorialTree('"+treeid+"','"+data.name()+"');");
							});
						});
					}
				});
			}
			function getTreeData(treeid,type,callback) {
				var levels=[];
				var nodes=[];
				var nodeCount=0;
				fb.child("tree").child(treeid).once("value",function(top) {
					var topNode=new Object();
					topNode.name=top.child("name").val();
					topNode.children=[];
					nodes[treeid]=topNode;
					levels[0]=[];
					levels[0].push(treeid);
					dtop=top.child("nodes");
					var count = 0;
					for(var prop in dtop.val()) {
						if(dtop.val().hasOwnProperty(prop))
							++count;
					}
					dtop.forEach(function(data) {
						fb.child(type).child(data.name()).child("name").once("value",function(name) {
							var currdata=data.val();
							currdata.name=name.val();
							var childarray=[];
							var parentarray=[];
							data.child("children").forEach(function(child) {
								childarray.push(child.name());
							});
							data.child("parents").forEach(function(parent) {
								parentarray.push(parent.name());
							});
							currdata.children=childarray;
							currdata.parents=parentarray;
							if(currdata.level==0) {
								nodes[treeid].children.push(data.name());
							}
							currdata.level++;
							levels[currdata.level] = ( typeof levels[currdata.level] != 'undefined' && levels[currdata.level] instanceof Array ) ? levels[currdata.level] : []
							levels[currdata.level].push(data.name());
							nodes[data.name()]=currdata;
							nodeCount++;
							if(nodeCount==count) {
								callback(nodes,levels);
							}
						});
					});
				});
			}
			function getGoalTreeData(treeid,checkNodes,callback) {
				var levels=[];
				var nodes=[];
				var nodeCount=0;
				fb.child("tree").child(treeid).once("value",function(top) {
					var topNode=new Object();
					topNode.name=top.child("name").val();
					topNode.children=[];
					nodes[treeid]=topNode;
					levels[0]=[];
					levels[0].push(treeid);
					dtop=top.child("nodes");
					dtop.forEach(function(data) {
						if($.inArray(data.name(),checkNodes)!=-1) {
							fb.child("tree").child(data.name()).child("name").once("value",function(name) {
								var currdata=data.val();
								currdata.name=name.val();
								var childarray=[];
								var parentarray=[];
								var childCount=0;
								data.child("children").forEach(function(child) {
									childarray.push(child.name());
									childCount++;
								});
								if(childCount==0) {
									var idOfTree=data.name();
									var parentLevel=currdata.level+1;
									fb.child("tree").child(idOfTree).once("value",function(top) {
										dtop=top.child("nodes");
										dtop.forEach(function(data) {
											if($.inArray(data.name(),checkNodes)!=-1) {
													fb.child("node").child(data.name()).child("name").once("value",function(name) {
													var currdata=data.val();
													currdata.name=name.val();
													var childarray=[];
													var parentarray=[];
													data.child("children").forEach(function(child) {
														childarray.push(child.name());
													});
													data.child("parents").forEach(function(parent) {
														parentarray.push(parent.name());
													});
													currdata.children=childarray;
													currdata.parents=parentarray;
													if(currdata.level==0) {
														nodes[idOfTree].children.push(data.name());
													}
													currdata.level+=parentLevel+1;
													levels[currdata.level] = ( typeof levels[currdata.level] != 'undefined' && levels[currdata.level] instanceof Array ) ? levels[currdata.level] : []
													levels[currdata.level].push(data.name());
													nodes[data.name()]=currdata;
													nodeCount++;
													if(nodeCount==checkNodes.length) {
														for(var n in nodes) {
															for(var i=0;i<nodes[n].children.length;i++) {
																if($.inArray(nodes[n].children[i],checkNodes)==-1) {
																	nodes[n].children.splice(i,1);
																	i--;
																}
															}
														}
														callback(nodes,levels);
													}
												});
											}
										});
									});
								}
								data.child("parents").forEach(function(parent) {
									parentarray.push(parent.name());
								});
								currdata.children=childarray;
								currdata.parents=parentarray;
								if(currdata.level==0) {
									nodes[treeid].children.push(data.name());
								}
								currdata.level++;
								levels[currdata.level] = ( typeof levels[currdata.level] != 'undefined' && levels[currdata.level] instanceof Array ) ? levels[currdata.level] : []
								levels[currdata.level].push(data.name());
								nodes[data.name()]=currdata;
								nodeCount++;
								if(childCount!=0&&nodeCount==checkNodes.length) {
									callback(nodes,levels);
								}
							});
						}
					});
				});
			}
			function drawTree(inNodes, inLevels) {
				$("#graph").html("");
				var graph = {nodes:inNodes,levels:inLevels};
				var width = window.innerWidth-270,
				  height = window.innerHeight-20;
				  radius = 40;
				var color = d3.scale.category20();
				  var nodes = [];
				  var links = []
				  var lookup = {};
				  var levelDepth = graph.levels.length;
				  var currentLevel = 1;
				  graph.levels.forEach(function(l) {
				    var levelIndex = 1;
				    l.forEach(function(node) {
				      var newNode = {};
					  newNode["id"] = node;
				      newNode["x"] = width/(l.length+1)*levelIndex;
				      newNode["y"] = height/(levelDepth+1)*currentLevel;
				      newNode["name"] = graph.nodes[node].name;
				      newNode["children"] = graph.nodes[node].children; 
				      lookup[node] = nodes.length; //Lookup table between node indices in "graph.nodes" and "nodes"
				      nodes.push(newNode);
				      levelIndex+=1;
				    });
				    currentLevel+=1;
				  });
				  nodes.forEach( function(node) {
				    node.children.forEach( function(child) {
				      links.push({source:node,target:nodes[lookup[child]]});
				    });
				  });
				var svg = d3.select("#graph").append("svg")
				    .attr("width",width)
				    .attr("height",height)
				   .append("g");
				svg.selectAll(".link")
				    .data(links)
				  .enter().append("svg:line")
				    .attr("x1",function(d) {return d.source.x; })
				    .attr("y1",function(d) {return d.source.y; })
				    .attr("x2",function(d) {return d.target.x; })
				    .attr("y2",function(d) {return d.target.y; })
				    .style("stroke", "rgb(0,0,0)");
				svg.selectAll(".node")
				    .data(nodes)
				  .enter().append("circle")
				    .attr("class","node")
				    .attr("r",radius)
				    .attr("cx", function(d) { return d.x })
				    .attr("cy", function(d) { return d.y })
					.attr("id", function(d) { return d.id })
					.attr("onclick", function(d) { return "goToNode('"+d.id+"');" })
				    .style("fill", function(d) { return color(5); })
				  .append("title")
				    .text(function(d) { return d.name; });
				svg.selectAll("text")
				    .data(nodes)
				  .enter().append("svg:text")
				    .attr("x", function(d) { return d.x})
				    .attr("y", function(d) { return d.y})
				    .attr("text-anchor", "middle")
					.attr("style","pointer-events: none;")
				    .text(function(d) { return d.name; });
			}
			function goToNode(id) {
				if(inTutorials) {
					switchToSubTutorialTree(currTutorialTree,id);
				} else {
					switchToSubCategory(currCategoryTree,id);
				}
			}
		</script>
	</body>
</html>
